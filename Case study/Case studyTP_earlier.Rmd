---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install and load necessary packages
```{r}
library(tidyverse)
library(mgcv)
library(lubridate)
library(readxl)
```

A function to change decimal comma to decimal point
```{r}
replace_comma <- function(values){
    values_parsed <- values %>% as.character() %>% parse_number(locale = locale(decimal_mark = ","))
}
```

Read concentration data för E23, replace decimal comma with decimal point, log-transform total phosphorus, create variables year, month and day
```{r}
mtransp<-read_excel("Analysvärden_E23_220208.xls", sheet="Analysvärden", skip=2, guess_max=20000)%>%filter(ID=="E23", Provtyp=="Manuellt prov")%>%
  mutate_at(c( "Totalkväve_mg/l", "Totalfosfor_mg/l", "Nitrat+nitritkväve_mg/l"),replace_comma)%>%
  mutate(logTN=log10(`Totalkväve_mg/l`), logTP=log10(`Totalfosfor_mg/l`+0.001), logNO3=log10(`Nitrat+nitritkväve_mg/l`+0.001), Year=as.numeric(substr(Datum, 1,4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))
```

Read discharge data, replace decimal comma with decimal point, create varialbe year, month and day, remove observations with a discharge of 0. 
```{r}
disch<-read_excel("Vattenföring_E23_220208.xls", sheet="Vattenföring", skip=2, guess_max=100000)%>%filter(ID=="E23")%>%
   mutate_at(c("Dygnsmedelflöde_l/s"),replace_comma)%>%
  mutate(logq=log10(`Dygnsmedelflöde_l/s`), Year=as.numeric(substr(Datum, 1, 4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))%>%
  filter(!(`Dygnsmedelflöde_l/s`==0))
```

Combine concentration and discharge data, create a decimal date variable and a variable indicating date within the year.
```{r}
E23<-mtransp%>%left_join(disch)%>%mutate(Date=as.Date( paste(Month, Day , Year , sep = "." )  , format = "%m.%d.%Y"), dec.date=decimal_date(Date), dec.during=dec.date-year(Date))

```

Read concentration data for U83, replace decimal comma with decimal point, log-transform total phosphorus, create variables year, month and day
```{r}
mtransp<-read_excel("Analysvärden_U8_220208.xls", sheet="Analysvärden", skip=2, guess_max=20000)%>%filter(ID=="U8", Provtyp=="Manuellt prov")%>%
  mutate_at(c( "Totalkväve_mg/l", "Totalfosfor_mg/l", "Nitrat+nitritkväve_mg/l"),replace_comma)%>%
  mutate(logTN=log10(`Totalkväve_mg/l`), logTP=log10(`Totalfosfor_mg/l`+0.001), logNO3=log10(`Nitrat+nitritkväve_mg/l`+0.001), Year=as.numeric(substr(Datum, 1,4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))
```

Read discharge data, replace decimal comma with decimal point, create varialbe year, month and day, remove observations with a discharge of 0. 
```{r}
disch<-read_excel("Vattenföring_U8_220208.xls", sheet="Vattenföring", skip=2, guess_max=100000)%>%filter(ID=="U8")%>%
   mutate_at(c("Dygnsmedelflöde_l/s"),replace_comma)%>%
  mutate(logq=log10(`Dygnsmedelflöde_l/s`), Year=as.numeric(substr(Datum, 1, 4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))%>%
  filter(!(`Dygnsmedelflöde_l/s`==0))%>%dplyr::select(-c(Kvalitetsklass))
```

Combine concentration and discharge data, create a decimal date variable and a variable indicating date within the year.
```{r}
U8<-mtransp%>%left_join(disch)%>%mutate(Date=as.Date( paste(Month, Day , Year , sep = "." )  , format = "%m.%d.%Y"), dec.date=decimal_date(Date), dec.during=dec.date-year(Date))

```



Time-varying c-q slope model, changing over seasons

```{r}
E23_mod<-gamm(logTP~te(Year, dec.during, bs=c("cr", "cc")) +te(Year, dec.during, by=logq,  bs=c("cr", "cc")),correlation=corCAR1(form=~dec.date),data=E23, method="REML")

```

Extract fitted values and c-q slope for the entire year
```{r}
terms23<-predict.gam(E23_mod$gam, type="terms", newdata=E23, se.fit=TRUE)

```

Figure 8, left
Plot of the year-season varying c-q slope
Define a grid for plotting, years from start to end, season as decimal 0 to 1, logq equal to 1 to extract the slope parameter. Estimated coefficients on this grid and plot
```{r}
newE23<-expand.grid(dec.during=seq(0,1, length.out=50), logq=rep(1, 50), Year=seq(min(E23$Year), max(E23$Year), length.out=50))

terms_newE23<-predict.gam(E23_mod$gam, type="terms", newdata=newE23, se.fit=TRUE)


newE23$terms<-terms_newE23$fit[,1]+attr(terms23, "constant")
newE23$coeff<-terms_newE23$fit[,2]

newE23$cont_month=newE23$dec.during*12+1
newE23$Month=floor(newE23$cont_month)
newE23$coeff.upper<-newE23$coeff+1.96*terms_newE23$se.fit[,2]
newE23$coeff.lower<-newE23$coeff-1.96*terms_newE23$se.fit[,2]

breaks <- c(-0.2, -0.1, 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4)

newE23%>%
ggplot(aes(x=Year, y=cont_month, z=coeff)) +
  geom_contour_filled(breaks=breaks)+
  xlab("Year")+
  theme_bw()+
  scale_y_continuous(name="Month", breaks=c(1,3,5,7,9,11))+
  labs(fill = "c-q slope")+
  theme(text= element_text(size = 9), legend.position="bottom", axis.title.x = element_text(size = 16), axis.title.y = element_text(size = 16))
```


Time-varying c-q slope model, changing over seasons

```{r}
U8_mod<-gamm(logTP~te(Year, dec.during, bs=c("cr", "cc")) +te(Year, dec.during, by=logq,  bs=c("cr", "cc")),correlation=corCAR1(form=~dec.date),data=U8, method="REML")

```

Extract fitted values and c-q slope for the entire year
```{r}
terms8<-predict.gam(U8_mod$gam, type="terms", newdata=U8, se.fit=TRUE)

```

Figure 8, left
Plot of the year-season varying c-q slope
Define a grid for plotting, years from start to end, season as decimal 0 to 1, logq equal to 1 to extract the slope parameter. Estimated coefficients on this grid and plot
```{r}
newU8<-expand.grid(dec.during=seq(0,1, length.out=50), logq=rep(1, 50), Year=seq(min(U8$Year), max(U8$Year), length.out=50))

terms_newU8<-predict.gam(U8_mod$gam, type="terms", newdata=newU8, se.fit=TRUE)
#terms_new1<-predict.gam(N34_mod$gam, type="response", exclude=c("te(year)", "te(decimal_during)"), newdata=new, se.fit=TRUE)

newU8$terms<-terms_newU8$fit[,1]+attr(terms8, "constant")
newU8$coeff<-terms_newU8$fit[,2]

newU8$cont_month=newU8$dec.during*12+1
newU8$Month=floor(newU8$cont_month)
newU8$coeff.upper<-newU8$coeff+1.96*terms_newU8$se.fit[,2]
newU8$coeff.lower<-newU8$coeff-1.96*terms_newU8$se.fit[,2]

breaks <- c(-0.2, -0.15,  -0.1, -0.05, 0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85,0.9, 0.95, 1)

newE23%>%mutate(site="E23")%>%full_join(newU8%>%mutate(site="U8"))%>%mutate(site=as.factor(site))->new_joint


new_joint%>%
ggplot(aes(x=Year, y=cont_month, z=coeff)) +
  stat_contour_filled(breaks=breaks)+
 scale_fill_viridis_d(drop = FALSE)+
  xlab("Year")+
  theme_bw()+
  scale_y_continuous(name="Month", breaks=c(1,3,5,7,9,11))+
  
  labs(fill = "c-q slope")+
  facet_wrap(~site)+
   theme(text= element_text(size = 12),legend.text=element_text(size=12), legend.position="bottom", strip.background = element_blank(),
  strip.text.x = element_blank(), axis.title.x = element_text(size = 16), axis.title.y = element_text(size = 16))+
  guides(fill=guide_legend(nrow=3))
```
```{r}

breaks <- c(-2,-1.9, -1.8,-1.7, -1.6, -1.5, -1.4, -1.3, -1.2, -1.1, -1,-0.9, -0.8,-0.7, -0.6,-0.5, -0.4, -0.3, -0.2,-0.1, 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6)

new_joint%>%
ggplot(aes(x=Year, y=cont_month, z=terms)) +
  stat_contour_filled(breaks=breaks)+
 scale_fill_viridis_d(drop = FALSE)+
  xlab("Year")+
  theme_bw()+
  scale_y_continuous(name="Month", breaks=c(1,3,5,7,9,11))+
  
  labs(fill = "Total phosphorus (log transformed")+
  facet_wrap(~site)+
   theme(text= element_text(size = 12),legend.text=element_text(size=12), legend.position="bottom", strip.background = element_blank(),
  strip.text.x = element_blank(), axis.title.x = element_text(size = 16), axis.title.y = element_text(size = 16))+
  guides(fill=guide_legend(nrow=3))
```


```{r}
newU8$cont_month=newU8$dec.during*12+1

newU8%>%filter(cont_month>8.4 & cont_month<8.6)%>%
  ggplot( aes(Year, coeff,coeff.lower,coeff.upper)) +
  geom_line(aes(y = coeff), color="red", lwd=2)+
  geom_line(aes(y = coeff.lower))+
  geom_line(aes(y = coeff.upper))+
  ylab("c-q slope")+
  geom_ribbon(aes(ymin=coeff.lower, ymax=coeff.upper),alpha=0.09, fill = "blue")+
  theme_bw()+
geom_line(data=newU8%>%filter(cont_month>2.4 & cont_month<2.6),aes(y = coeff), color="blue", lwd=2)+
    geom_line(data=newU8%>%filter(cont_month>2.4 & cont_month<2.6),aes(y = coeff.lower))+
  geom_line(data=newU8%>%filter(cont_month>2.4 & cont_month<2.6),aes(y = coeff.upper))+
  geom_ribbon(data=newU8%>%filter(cont_month>2.4 & cont_month<2.6),aes(ymin=coeff.lower, ymax=coeff.upper),alpha=0.09, fill = "blue")+
  theme(text= element_text(size = 16))
```



NONLINEAR
Define seasons
```{r}
E23$seas<-1
E23$seas[E23$Month==3| E23$Month==4 | E23$Month ==5]<-2
E23$seas[E23$Month==6| E23$Month==7 | E23$Month ==8]<-3
E23$seas[E23$Month==9| E23$Month==10 | E23$Month ==11]<-4
E23$seas<-as.factor(E23$seas)
```

Run a model including different c-q slopes for separate seasons
```{r}
modE23_seas<-gamm(logTP~s(dec.date)+seas+s(logq, by=seas),correlation=corCAR1(form = ~dec.date),method="REML", data=E23)
summary(modE23_seas$gam)
```

Basic model to extract standard slope
```{r}
modE23<-gamm(logTP~s(dec.date)+logq,correlation=corCAR1(form = ~dec.date),method="REML", data=E23)
summary(modE23$gam)
```



Spring, Summer, Autum and Winter scatter plots for log TP in U8
```{r}
terms1<-predict(modE23_seas$gam, type="terms", newdata=E23, se.fit=TRUE)

E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg<-terms1$se.fit[,4]
E23$line<-terms1$fit[,4]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper<-E23$line+2*terms1$se.fit[,4]
E23$Line_lower<-E23$line-2*terms1$se.fit[,4]

E23%>%
  filter(seas==2, Year<2015)%>%
  ggplot(aes(x=logq, y=logTP, Line_lower,Line_upper))+
  geom_point()+
geom_point(data=E23%>%filter(seas==2, Year>=2015), aes(x=logq, y=logTP), col="red")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
    ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
 theme(text= element_text(size = 16), plot.title = element_text(size=16),
        axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Spring")->E23_2plot


#Summer

E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg<-terms1$se.fit[,5]
E23$line<-terms1$fit[,5]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper<-E23$line+2*terms1$se.fit[,5]
E23$Line_lower<-E23$line-2*terms1$se.fit[,5]

E23%>%
  filter(seas==3, Year<2015)%>%
  ggplot(aes(x=logq, y=logTP, Line_lower,Line_upper))+
  geom_point()+
  geom_point(data=E23%>%filter(seas==3, Year>=2015), aes(x=logq, y=logTP), col="red")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
    ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
   theme(text= element_text(size = 16), plot.title = element_text(size=16),
         axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Summer")->E23_3plot

#Autumn

E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg<-terms1$se.fit[,6]
E23$line<-terms1$fit[,6]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper<-E23$line+2*terms1$se.fit[,6]
E23$Line_lower<-E23$line-2*terms1$se.fit[,6]


E23%>%
  filter(seas==4, Year<2015)%>%
  ggplot(aes(x=logq, y=logTP, Line_lower,Line_upper))+
  geom_point()+
geom_point(data=E23%>%filter(seas==4, Year>=2015), aes(x=logq, y=logTP), col="red")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
    ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
   theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Autumn")->E23_4plot


#Winter

E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg<-terms1$se.fit[,3]
E23$line<-terms1$fit[,3]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper<-E23$line+2*terms1$se.fit[,3]
E23$Line_lower<-E23$line-2*terms1$se.fit[,3]

E23%>%
  filter(seas==1, Year<2015)%>%
  ggplot(aes(x=logq, y=logTP, Line_lower,Line_upper))+
  geom_point()+
  geom_point(data=E23%>%filter(seas==1, Year>=2015), aes(x=logq, y=logTP), col="red")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
   theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Winter")->E23_1plot

```


```{r}
library(ggpubr)
ggarrange(E23_1plot, E23_2plot, E23_3plot, E23_4plot, ncol=2, nrow=2)
```


```{r}
termsseas<-predict.gam(modE23_seas$gam, type="terms", newdata=E23, se.fit=TRUE)

ff_seas<-derivatives(modE23_seas)
```


Spring, Summer, Autum and Winter c-q plots for log TP in E23
```{r}
ff_seas%>%filter(var=="logq", smooth=="s(logq):seas2")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+
  ylim(-2,2)+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
        axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Spring")->E23_2_cqplot



ff_seas%>%filter(var=="logq", smooth=="s(logq):seas3")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+
  ylim(-2,2)+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
        axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Summer")->E23_3_cqplot


ff_seas%>%filter(var=="logq", smooth=="s(logq):seas4")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+

  ylim(-2,2)+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
        axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Autumn")->E23_4_cqplot



ff_seas%>%filter(var=="logq", smooth=="s(logq):seas1")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  ylim(-2,2)+
    theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Winter")->E23_1_cqplot


```

```{r}
library(ggpubr)
ggarrange(E23_1_cqplot, E23_2_cqplot, E23_3_cqplot, E23_4_cqplot, ncol=2, nrow=2)
```






NONLINEAR  U8
Define seasons

```{r}

U8$seas<-1
U8$seas[U8$Month==3| U8$Month==4 | U8$Month ==5]<-2
U8$seas[U8$Month==6| U8$Month==7 | U8$Month ==8]<-3
U8$seas[U8$Month==9| U8$Month==10 | U8$Month ==11]<-4
U8$seas<-as.factor(U8$seas)
```

Run a model including different c-q slopes for separate seasons
```{r}

modU8_seas<-gamm(logTP~s(dec.date)+seas+s(logq, by=seas),correlation=corCAR1(form = ~dec.date),method="REML", data=U8)
summary(modU8_seas$gam)
```

Basic model to extract standard slope
```{r}
modU8<-gamm(logTP~s(dec.date)+logq,correlation=corCAR1(form = ~dec.date),method="REML", data=U8)
summary(modU8$gam)
```


Spring, Summer, Autum and Winter scatter plots for log TP in U8
```{r}
terms1<-predict(modU8_seas$gam, type="terms", newdata=U8, se.fit=TRUE)

U8$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(U8$logq, na.rm=TRUE)*summary(modU8$gam)$p.coeff[2]
U8$sereg<-terms1$se.fit[,4]
U8$line<-terms1$fit[,4]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$Line_upper<-U8$line+2*terms1$se.fit[,4]
U8$Line_lower<-U8$line-2*terms1$se.fit[,4]

U8%>%
  filter(seas==2, Year<2015)%>%
  ggplot(aes(x=logq, y=logTP, Line_lower,Line_upper))+
  geom_point()+
geom_point(data=U8%>%filter(seas==2, Year>=2015), aes(x=logq, y=logTP), col="red")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
    ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
 theme(text= element_text(size = 16), plot.title = element_text(size=16),
       axis.title.x = element_blank(),axis.title.y = element_blank())+
         labs(title="Spring")->U8_2plot

#Summer

U8$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(U8$logq, na.rm=TRUE)*summary(modU8$gam)$p.coeff[2]
U8$sereg<-terms1$se.fit[,5]
U8$line<-terms1$fit[,5]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$Line_upper<-U8$line+2*terms1$se.fit[,5]
U8$Line_lower<-U8$line-2*terms1$se.fit[,5]

U8%>%
  filter(seas==3, Year<2015)%>%
  ggplot(aes(x=logq, y=logTP, Line_lower,Line_upper))+
  geom_point()+
  geom_point(data=U8%>%filter(seas==3, Year>=2015), aes(x=logq, y=logTP), col="red")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
    ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
   theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Summer")->U8_3plot

#Autumn

U8$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(U8$logq, na.rm=TRUE)*summary(modU8$gam)$p.coeff[2]
U8$sereg<-terms1$se.fit[,6]
U8$line<-terms1$fit[,6]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$Line_upper<-U8$line+2*terms1$se.fit[,6]
U8$Line_lower<-U8$line-2*terms1$se.fit[,6]

U8%>%
  filter(seas==4, Year<2015)%>%
  ggplot(aes(x=logq, y=logTP, Line_lower,Line_upper))+
  geom_point()+
geom_point(data=U8%>%filter(seas==4, Year>=2015), aes(x=logq, y=logTP), col="red")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
    ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
   theme(text= element_text(size = 16), plot.title = element_text(size=16),
         axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Autumn")->U8_4plot

#Winter

U8$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(U8$logq, na.rm=TRUE)*summary(modU8$gam)$p.coeff[2]
U8$sereg<-terms1$se.fit[,3]
U8$line<-terms1$fit[,3]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$Line_upper<-U8$line+2*terms1$se.fit[,3]
U8$Line_lower<-U8$line-2*terms1$se.fit[,3]

U8%>%
  filter(seas==1, Year<2015)%>%
  ggplot(aes(x=logq, y=logTP, Line_lower,Line_upper))+
  geom_point()+
  geom_point(data=U8%>%filter(seas==1, Year>=2015), aes(x=logq, y=logTP), col="red")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
   theme(text= element_text(size = 16), plot.title = element_text(size=16), 
         axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Winter")->U8_1plot

```

```{r}

library(ggpubr)
ggarrange(U8_1plot, U8_2plot, U8_3plot, U8_4plot, ncol=2, nrow=2)
```

```{r}
pp_all<-ggarrange(E23_1plot, E23_2plot, E23_3plot, E23_4plot, U8_1plot, U8_2plot, U8_3plot, U8_4plot, ncol=4, nrow=2)

annotate_figure(pp_all, left=text_grob("Total phosphorus (log-transformed)", rot=90, size=16), bottom=text_grob("Discharge (log-transformed)", size=16))
```





Extract c-q slopes from the seasonal model using derivatives 
```{r}


library(gratia)
termsseas<-predict.gam(modU8_seas$gam, type="terms", newdata=U8, se.fit=TRUE)

ff_seas<-derivatives(modU8_seas)
```


Spring, Summer, Autum and Winter c-q plots for log TP in U8
```{r}
ff_seas%>%filter(var=="logq", smooth=="s(logq):seas2")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+

  ylim(-2,2)+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
        axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Spring")->U8_2_cqplot


ff_seas%>%filter(var=="logq", smooth=="s(logq):seas3")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+

  ylim(-2,2)+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
        axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Summer")->U8_3_cqplot



ff_seas%>%filter(var=="logq", smooth=="s(logq):seas4")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+

  ylim(-2,2)+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
        axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Autumn")->U8_4_cqplot


ff_seas%>%filter(var=="logq", smooth=="s(logq):seas1")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  ylim(-2,2)+
    theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Winter")->U8_1_cqplot


```

```{r}

library(ggpubr)
ggarrange(U8_1_cqplot, U8_2_cqplot, U8_3_cqplot, U8_4_cqplot, ncol=2, nrow=2)
```

```{r}
pp_cqall<-ggarrange(E23_1_cqplot, E23_2_cqplot, E23_3_cqplot, E23_4_cqplot, U8_1_cqplot, U8_2_cqplot, U8_3_cqplot, U8_4_cqplot, ncol=4, nrow=2)
annotate_figure(pp_cqall, left=text_grob("c-q slope", rot=90, size=16), bottom=text_grob("Discharge (log-transformed)", size=16))
```

```{r}
TP_trend<-gamm(logTP~te(Year, Month),correlation=corCAR1(form=~dec.date),data=E23, method="REML")

flow_trendE23<-gamm(logq~s(Year, Month), data=E23_a)
summary(flow_trendE23$gam)
plot(flow_trendE23$gam)


#new<-expand.grid(Year=seq(min(E23_a$Year), max(E23_a$Year), length.out=50), Month=seq(1,12, length.out=50))
new<-expand.grid(Year=seq(min(E23$Year), max(E23$Year), length.out=50), Month=seq(1,12, length.out=50))

predict_TP<-predict.gam(TP_trend$gam, type="response", newdata=new, se.fit=TRUE)
#terms_new1<-predict.gam(N34_mod$gam, type="response", exclude=c("te(year)", "te(decimal_during)"), newdata=new, se.fit=TRUE)

new$fit<-predict_TP$fit
new$fit.upper<-new$fit+1.96*predict_TP$se.fit
new$fit.lower<-new$fit-1.96*predict_TP$se.fit

new%>%
ggplot(aes(x=Year, y=Month, z=fit)) +
  stat_contour_filled()+
    scale_fill_viridis_d(drop = FALSE)+
  # geom_point(data=E23_a,aes(x=Year, y=Month),inherit.aes=FALSE)+
  xlab("Year")+
   xlim(1988, 2021)+
  theme_bw()+
   scale_y_continuous(name="Month", breaks=c(1,3,5,7,9,11))+
  labs(fill = "Log-transformed TP")+
  theme(text= element_text(size = 16), legend.text=element_text(size=16))->E23_TP
```

