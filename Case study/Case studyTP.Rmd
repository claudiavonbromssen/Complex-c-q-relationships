---
title: "Case studies TP"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install and load necessary packages
```{r}
library(tidyverse)
library(mgcv)
library(lubridate)
library(readxl)
library(gratia)
```

A function to change decimal comma to decimal point
```{r}
replace_comma <- function(values){
    values_parsed <- values %>% as.character() %>% parse_number(locale = locale(decimal_mark = ","))
}
```

Read concentration data för E23, replace decimal comma with decimal point, log-transform total phosphorus, create variables year, month and day
```{r}
mtransp<-read_excel("Analysvärden_E23_220208.xls", sheet="Analysvärden", skip=2, guess_max=20000)%>%filter(ID=="E23", Provtyp=="Manuellt prov")%>%
  mutate_at(c( "Totalkväve_mg/l", "Totalfosfor_mg/l", "Nitrat+nitritkväve_mg/l"),replace_comma)%>%
  mutate(logTN=log10(`Totalkväve_mg/l`), logTP=log10(`Totalfosfor_mg/l`+0.001), logNO3=log10(`Nitrat+nitritkväve_mg/l`+0.001), Year=as.numeric(substr(Datum, 1,4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))
```

Read discharge data, replace decimal comma with decimal point, create varialbe year, month and day, remove observations with a discharge of 0. 
```{r}
disch<-read_excel("Vattenföring_E23_220208.xls", sheet="Vattenföring", skip=2, guess_max=100000)%>%filter(ID=="E23")%>%
   mutate_at(c("Dygnsmedelflöde_l/s"),replace_comma)%>%
  mutate(logq=log10(`Dygnsmedelflöde_l/s`), Year=as.numeric(substr(Datum, 1, 4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))%>%
  filter(!(`Dygnsmedelflöde_l/s`==0))
```

Combine concentration and discharge data, create a decimal date variable and a variable indicating date within the year.
```{r}
E23<-mtransp%>%left_join(disch)%>%mutate(Date=as.Date( paste(Month, Day , Year , sep = "." )  , format = "%m.%d.%Y"), dec.date=decimal_date(Date), dec.during=dec.date-year(Date))

```

Read concentration data för E23, replace decimal comma with decimal point, log-transform total phosphorus, create variables year, month and day
```{r}
mtransp<-read_excel("Analysvärden_U8_220208.xls", sheet="Analysvärden", skip=2, guess_max=20000)%>%filter(ID=="U8", Provtyp=="Manuellt prov")%>%
  mutate_at(c( "Totalkväve_mg/l", "Totalfosfor_mg/l", "Nitrat+nitritkväve_mg/l"),replace_comma)%>%
  mutate(logTN=log10(`Totalkväve_mg/l`), logTP=log10(`Totalfosfor_mg/l`+0.001), logNO3=log10(`Nitrat+nitritkväve_mg/l`+0.001), Year=as.numeric(substr(Datum, 1,4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))
```

Read discharge data, replace decimal comma with decimal point, create varialbe year, month and day, remove observations with a discharge of 0. 
```{r}
disch<-read_excel("Vattenföring_U8_220208.xls", sheet="Vattenföring", skip=2, guess_max=100000)%>%filter(ID=="U8")%>%
   mutate_at(c("Dygnsmedelflöde_l/s"),replace_comma)%>%
  mutate(logq=log10(`Dygnsmedelflöde_l/s`), Year=as.numeric(substr(Datum, 1, 4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))%>%
  filter(!(`Dygnsmedelflöde_l/s`==0))%>%dplyr::select(-c(Kvalitetsklass))
```

Combine concentration and discharge data, create a decimal date variable and a variable indicating date within the year.
```{r}
U8<-mtransp%>%left_join(disch)%>%mutate(Date=as.Date( paste(Month, Day , Year , sep = "." )  , format = "%m.%d.%Y"), dec.date=decimal_date(Date), dec.during=dec.date-year(Date))

```

Check if c-q slopes are nonlinear and if the structure varies with season (GAM_nonlinear and seasonal). Results not given in the article.
Define seasons and run model.
```{r}
E23$seas<-1
E23$seas[E23$Month==3| E23$Month==4 | E23$Month ==5]<-2
E23$seas[E23$Month==6| E23$Month==7 | E23$Month ==8]<-3
E23$seas[E23$Month==9| E23$Month==10 | E23$Month ==11]<-4
E23$seas<-as.factor(E23$seas)


modE23_seas<-gamm(logTP~s(dec.date)+seas+s(logq, by=seas),correlation=corCAR1(form = ~dec.date),method="REML", data=E23)
summary(modE23_seas$gam)
```


Define two time periods (before 2015 and 2015 and later)
```{r}
E23$per<-2
E23$per[E23$Year<2015]<-1
E23$group<-as.factor(paste(E23$per, E23$seas))
```

Run a model including different c-q slopes for separate seasons for each of the time periods (GAM_nonlinear and seasonal separated for groups)
```{r}
modE23_seas<-gamm(logTP~s(dec.date)+group+s(logq, by=group),correlation=corCAR1(form = ~dec.date),method="REML", data=E23)
summary(modE23_seas$gam)
```

Basic model to extract standard slope
```{r}
modE23<-gamm(logTP~s(dec.date)+logq,correlation=corCAR1(form = ~dec.date),method="REML", data=E23)
summary(modE23$gam)
```

Plots of nonlinear relationships
```{r}
# Spring
terms1<-predict(modE23_seas$gam, type="terms", newdata=E23, se.fit=TRUE)

E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg1<-terms1$se.fit[,4]
E23$line1<-terms1$fit[,4]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$line2<-terms1$fit[,8]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper1<-E23$line1+2*terms1$se.fit[,4]
E23$Line_lower1<-E23$line1-2*terms1$se.fit[,4]
E23$Line_upper2<-E23$line2+2*terms1$se.fit[,8]
E23$Line_lower2<-E23$line2-2*terms1$se.fit[,8]

E23%>%
  filter(group=="1 2")%>%
  ggplot(aes(x=logq, y=logTP))+
  geom_point()+
  geom_line(aes(x=logq, y=line1), col="black",lwd=1)+
  geom_point(data=E23%>%filter(group=="2 2"), aes(x=logq, y=logTP),col="red")+
  geom_line(data=E23%>%filter(group=="2 2"),aes(x=logq, y=line2), col="red",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Spring")->E23_2plot


#Summer

E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg1<-terms1$se.fit[,5]
E23$line1<-terms1$fit[,5]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$line2<-terms1$fit[,9]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper1<-E23$line1+2*terms1$se.fit[,5]
E23$Line_lower1<-E23$line1-2*terms1$se.fit[,5]
E23$Line_upper2<-E23$line2+2*terms1$se.fit[,9]
E23$Line_lower2<-E23$line2-2*terms1$se.fit[,9]

E23%>%
  filter(group=="1 3")%>%
  ggplot(aes(x=logq, y=logTP))+
  geom_point()+
  geom_line(aes(x=logq, y=line1), col="black",lwd=1)+
  geom_point(data=E23%>%filter(group=="2 3"), aes(x=logq, y=logTP),col="red")+
  geom_line(data=E23%>%filter(group=="2 3"),aes(x=logq, y=line2), col="red",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Summer")->E23_3plot

#Autumn

E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg1<-terms1$se.fit[,6]
E23$line1<-terms1$fit[,6]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$line2<-terms1$fit[,10]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper1<-E23$line1+2*terms1$se.fit[,6]
E23$Line_lower1<-E23$line1-2*terms1$se.fit[,6]
E23$Line_upper2<-E23$line2+2*terms1$se.fit[,10]
E23$Line_lower2<-E23$line2-2*terms1$se.fit[,10]

E23%>%
  filter(group=="1 4")%>%
  ggplot(aes(x=logq, y=logTP))+
  geom_point()+
  geom_line(aes(x=logq, y=line1), col="black",lwd=1)+
  geom_point(data=E23%>%filter(group=="2 4"), aes(x=logq, y=logTP),col="red")+
  geom_line(data=E23%>%filter(group=="2 4"),aes(x=logq, y=line2), col="red",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Autumn")->E23_4plot


#Winter

E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg1<-terms1$se.fit[,3]
E23$line1<-terms1$fit[,3]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$line2<-terms1$fit[,7]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper1<-E23$line1+2*terms1$se.fit[,3]
E23$Line_lower1<-E23$line1-2*terms1$se.fit[,3]
E23$Line_upper2<-E23$line2+2*terms1$se.fit[,7]
E23$Line_lower2<-E23$line2-2*terms1$se.fit[,7]

E23%>%
  filter(group=="1 1")%>%
  ggplot(aes(x=logq, y=logTP))+
  geom_point()+
  geom_line(aes(x=logq, y=line1), col="black",lwd=1)+
  geom_point(data=E23%>%filter(group=="2 1"), aes(x=logq, y=logTP),col="red")+
  geom_line(data=E23%>%filter(group=="2 1"),aes(x=logq, y=line2), col="red",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Winter")->E23_1plot

```

Composition of plots
```{r}
library(ggpubr)
ggarrange(E23_1plot, E23_2plot, E23_3plot, E23_4plot, ncol=2, nrow=2)
```


Compute c-q slopes

```{r}
termsseas<-predict.gam(modE23_seas$gam, type="terms", newdata=E23, se.fit=TRUE)

ff_seas<-derivatives(modE23_seas)
```

C-q slope plot for four seasons and two time periods
```{r}
ff_seas%>%filter(smooth != "s(dec.date)")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+

  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
        axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="E23")+
  facet_wrap(~smooth, ncol=4, labeller = as_labeller(c(`s(logq):group1 1` = "Winter (before 2015)", `s(logq):group1 2` = "Spring (before 2015)", `s(logq):group1 3` = "Summer (before 2015)", `s(logq):group1 4` = "Autumn (before 2015)", `s(logq):group2 1` = "Winter (2015 and later)",`s(logq):group2 2` = "Spring (2015 and later)",`s(logq):group2 3` = "Summer (2015 and later)",`s(logq):group2 4` = "Autumn (2015 and later)")))->E23_cqplot





```

Nonlinear models for U8

Define seasons and groups
```{r}

U8$seas<-1
U8$seas[U8$Month==3| U8$Month==4 | U8$Month ==5]<-2
U8$seas[U8$Month==6| U8$Month==7 | U8$Month ==8]<-3
U8$seas[U8$Month==9| U8$Month==10 | U8$Month ==11]<-4
U8$seas<-as.factor(U8$seas)
U8$per<-2
U8$per[U8$Year<2015]<-1
U8$group<-as.factor(paste(U8$per, U8$seas))
```

Run a model including different c-q slopes for separate seasons for the entire time period
```{r}

modU8_seas<-gamm(logTP~s(dec.date)+group+s(logq, by=group),correlation=corCAR1(form = ~dec.date),method="REML", data=U8)
summary(modU8_seas$gam)
```

Run a model including different c-q slopes for separate seasons for each of the time periods (before 2015, 2015 and later, GAM_nonlinear and seasonal separated for groups)

```{r}
modU8_seas<-gamm(logTP~s(dec.date)+group+s(logq, by=group),correlation=corCAR1(form = ~dec.date),method="REML", data=U8)
summary(modU8_seas$gam)
```


Basic model to extract standard slope
```{r}
modU8<-gamm(logTP~s(dec.date)+logq,correlation=corCAR1(form = ~dec.date),method="REML", data=U8)
summary(modU8$gam)
```

Plots of nonlinear relationships in U8

```{r}

#Spring
terms1<-predict(modU8_seas$gam, type="terms", newdata=U8, se.fit=TRUE)

U8$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(U8$logq, na.rm=TRUE)*summary(modU8$gam)$p.coeff[2]
U8$sereg1<-terms1$se.fit[,4]
U8$line1<-terms1$fit[,4]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$line2<-terms1$fit[,8]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$Line_upper1<-U8$line1+2*terms1$se.fit[,4]
U8$Line_lower1<-U8$line1-2*terms1$se.fit[,4]
U8$Line_upper2<-U8$line2+2*terms1$se.fit[,8]
U8$Line_lower2<-U8$line2-2*terms1$se.fit[,8]

U8%>%
  filter(group=="1 2")%>%
  ggplot(aes(x=logq, y=logTP))+
  geom_point()+
  geom_line(aes(x=logq, y=line1), col="black",lwd=1)+
  geom_point(data=U8%>%filter(group=="2 2"), aes(x=logq, y=logTP),col="red")+
  geom_line(data=U8%>%filter(group=="2 2"),aes(x=logq, y=line2), col="red",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Spring")->U8_2plot


#Summer

U8$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(U8$logq, na.rm=TRUE)*summary(modU8$gam)$p.coeff[2]
U8$sereg1<-terms1$se.fit[,5]
U8$line1<-terms1$fit[,5]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$line2<-terms1$fit[,9]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$Line_upper1<-U8$line1+2*terms1$se.fit[,5]
U8$Line_lower1<-U8$line1-2*terms1$se.fit[,5]
U8$Line_upper2<-U8$line2+2*terms1$se.fit[,9]
U8$Line_lower2<-U8$line2-2*terms1$se.fit[,9]

U8%>%
  filter(group=="1 3")%>%
  ggplot(aes(x=logq, y=logTP))+
  geom_point()+
  geom_line(aes(x=logq, y=line1), col="black",lwd=1)+
  geom_point(data=U8%>%filter(group=="2 3"), aes(x=logq, y=logTP),col="red")+
  geom_line(data=U8%>%filter(group=="2 3"),aes(x=logq, y=line2), col="red",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Summer")->U8_3plot

#Autumn

U8$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(U8$logq, na.rm=TRUE)*summary(modU8$gam)$p.coeff[2]
U8$sereg1<-terms1$se.fit[,6]
U8$line1<-terms1$fit[,6]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$line2<-terms1$fit[,10]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$Line_upper1<-U8$line1+2*terms1$se.fit[,6]
U8$Line_lower1<-U8$line1-2*terms1$se.fit[,6]
U8$Line_upper2<-U8$line2+2*terms1$se.fit[,10]
U8$Line_lower2<-U8$line2-2*terms1$se.fit[,10]

U8%>%
  filter(group=="1 4")%>%
  ggplot(aes(x=logq, y=logTP))+
  geom_point()+
  geom_line(aes(x=logq, y=line1), col="black",lwd=1)+
  geom_point(data=U8%>%filter(group=="2 4"), aes(x=logq, y=logTP),col="red")+
  geom_line(data=U8%>%filter(group=="2 4"),aes(x=logq, y=line2), col="red",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Autumn")->U8_4plot


#Winter

U8$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(U8$logq, na.rm=TRUE)*summary(modU8$gam)$p.coeff[2]
U8$sereg1<-terms1$se.fit[,3]
U8$line1<-terms1$fit[,3]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$line2<-terms1$fit[,7]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
U8$Line_upper1<-U8$line1+2*terms1$se.fit[,3]
U8$Line_lower1<-U8$line1-2*terms1$se.fit[,3]
U8$Line_upper2<-U8$line2+2*terms1$se.fit[,7]
U8$Line_lower2<-U8$line2-2*terms1$se.fit[,7]

U8%>%
  filter(group=="1 1")%>%
  ggplot(aes(x=logq, y=logTP))+
  geom_point()+
  geom_line(aes(x=logq, y=line1), col="black",lwd=1)+
  geom_point(data=U8%>%filter(group=="2 1"), aes(x=logq, y=logTP),col="red")+
  geom_line(data=U8%>%filter(group=="2 1"),aes(x=logq, y=line2), col="red",lwd=1)+
  ylim(-2, 0.5)+
  xlim(-1, 3)+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
          axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="Winter")->U8_1plot

```

Composition of plots for U8
```{r}

library(ggpubr)
ggarrange(U8_1plot, U8_2plot, U8_3plot, U8_4plot, ncol=2, nrow=2)
```

##########################################################
Figure 7: Nonlinear c-q relationships for TP at E23 and U8
##########################################################
```{r}
pp_all<-ggarrange(E23_1plot, E23_2plot, E23_3plot, E23_4plot, U8_1plot, U8_2plot, U8_3plot, U8_4plot, ncol=4, nrow=2)
annotate_figure(pp_all, left=text_grob("Total phosphorus (log-transformed)", rot=90, size=16), bottom=text_grob("Discharge (log-transformed)", size=16))

```





Extract c-q slopes from the seasonal model using derivatives for U8
```{r}
termsseas<-predict.gam(modU8_seas$gam, type="terms", newdata=U8, se.fit=TRUE)

ff_seas<-derivatives(modU8_seas)
```


C-q slope plot for four seasons and two time periods in U8


```{r}
ff_seas%>%filter(smooth != "s(dec.date)")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+

  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16),
        axis.title.x = element_blank(),axis.title.y = element_blank())+
  labs(title="U8")+
  facet_wrap(~smooth, ncol=4, labeller = as_labeller(c(`s(logq):group1 1` = "Winter (before 2015)", `s(logq):group1 2` = "Spring (before 2015)", `s(logq):group1 3` = "Summer (before 2015)", `s(logq):group1 4` = "Autumn (before 2015)", `s(logq):group2 1` = "Winter (2015 and later)",`s(logq):group2 2` = "Spring (2015 and later)",`s(logq):group2 3` = "Summer (2015 and later)",`s(logq):group2 4` = "Autumn (2015 and later)")))->U8_cqplot





```

###############################################################################
Figure S.4: C-q slope plot for four seasons and two time periods in *E23 and U8
###############################################################################

```{r}
pp_cq<-ggarrange(E23_cqplot, U8_cqplot, ncol=1, nrow=2)
annotate_figure(pp_cq, left=text_grob("cq-slope", rot=90, size=16), bottom=text_grob("Discharge (log-transformed)", size=16))
```


Plot of TP levels (not shown in article)

```{r}
TP_trendE23<-gamm(logTP~s(Year, Month), data=E23)
summary(TP_trendE23$gam)
plot(TP_trendE23$gam)


new<-expand.grid(Year=seq(min(E23$Year), max(E23$Year), length.out=50), Month=seq(1,12, length.out=50))

predict_TP<-predict.gam(TP_trendE23$gam, type="response", newdata=new, se.fit=TRUE)

new$fit<-predict_TP$fit
new$fit.upper<-new$fit+1.96*predict_TP$se.fit
new$fit.lower<-new$fit-1.96*predict_TP$se.fit

new%>%
ggplot(aes(x=Year, y=Month, z=fit)) +
  stat_contour_filled()+
    scale_fill_viridis_d(drop = FALSE)+
  # geom_point(data=E23_a,aes(x=Year, y=Month),inherit.aes=FALSE)+
  xlab("Year")+
   xlim(1988, 2021)+
  theme_bw()+
   scale_y_continuous(name="Month", breaks=c(1,3,5,7,9,11))+
  labs(fill = "Log-transformed TP")+
  theme(text= element_text(size = 16), legend.text=element_text(size=16))->E23_TP
```

```{r}
TP_trendU8<-gamm(logTP~s(Year, Month), data=U8)
summary(TP_trendU8$gam)
plot(TP_trendU8$gam)


new<-expand.grid(Year=seq(min(U8$Year), max(U8$Year), length.out=50), Month=seq(1,12, length.out=50))

predict_TP<-predict.gam(TP_trendU8$gam, type="response", newdata=new, se.fit=TRUE)

new$fit<-predict_TP$fit
new$fit.upper<-new$fit+1.96*predict_TP$se.fit
new$fit.lower<-new$fit-1.96*predict_TP$se.fit

new%>%
ggplot(aes(x=Year, y=Month, z=fit)) +
  stat_contour_filled()+
    scale_fill_viridis_d(drop = FALSE)+
  # geom_point(data=E23_a,aes(x=Year, y=Month),inherit.aes=FALSE)+
  xlab("Year")+
   xlim(1988, 2021)+
  theme_bw()+
   scale_y_continuous(name="Month", breaks=c(1,3,5,7,9,11))+
  labs(fill = "Log-transformed TP")+
  theme(text= element_text(size = 16), legend.text=element_text(size=16))->U8_TP
```

