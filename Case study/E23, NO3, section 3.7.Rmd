---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install and load necessary packages
```{r}
library(tidyverse)
library(mgcv)
library(lubridate)
library(readxl)
```

A function to change decimal comma to decimal point
```{r}
replace_comma <- function(values){
    values_parsed <- values %>% as.character() %>% parse_number(locale = locale(decimal_mark = ","))
}
```

Read concentration data för E23, replace decimal comma with decimal point, log-transform total phosphorus, create variables year, month and day
```{r}
mtransp<-read_excel("Jordbruk_analysvärden.xls", sheet="Analysvärden", skip=2, guess_max=20000)%>%filter(ID=="E23", Provtyp=="Manuellt prov")%>%
  mutate_at(c( "Totalkväve_mg/l", "Totalfosfor_mg/l", "Nitrat+nitritkväve_mg/l"),replace_comma)%>%
  mutate(logTN=log10(`Totalkväve_mg/l`), logTP=log10(`Totalfosfor_mg/l`), logNO3=log10(`Nitrat+nitritkväve_mg/l`), Year=as.numeric(substr(Datum, 1,4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))%>%filter(!(`Nitrat+nitritkväve_mg/l`==0))
```

Read discharge data, replace decimal comma with decimal point, create varialbe year, month and day, remove observations with a discharge of 0. 
```{r}
disch<-read_excel("Vattenföring_E-län_210323.xls", sheet="Vattenföring", skip=2, guess_max=100000)%>%filter(ID=="E23")%>%
   mutate_at(c("Dygnsmedelflöde_l/s"),replace_comma)%>%
  mutate(logq=log10(`Dygnsmedelflöde_l/s`), Year=as.numeric(substr(Datum, 1, 4)), Month=as.numeric(substr(Datum, 6,7)), Day=as.numeric(substr(Datum, 9,10)))%>%
  filter(!(`Dygnsmedelflöde_l/s`==0))
```

Combine concentration and discharge data, create a decimal date variable and a variable indicating date within the year.
```{r}
E23<-mtransp%>%left_join(disch)%>%mutate(Date=as.Date( paste(Month, Day , Year , sep = "." )  , format = "%m.%d.%Y"), dec.date=decimal_date(Date), dec.during=dec.date-year(Date))

```

constant c-q slope with and without trend for table 1.
```{r}
E23mod_without<-lm(logNO3~logq, data=E23)
summary(E23mod_without)

E23mod_withtrend<-gamm(logNO3~s(dec.date)+logq, correlation=corCAR1(form = ~dec.date),method="REML", data=E23)
summary(E23mod_withtrend$gam)
```


Time-varying c-q slope model, changing over seasons

```{r}
E23_mod<-gamm(logNO3~te(Year, dec.during, bs=c("cr", "cc")) +te(Year, dec.during, by=logq,  bs=c("cr", "cc")),correlation=corCAR1(form=~dec.date),data=E23, method="REML")


#Without autocorrelation term,in case the upper one does not run
#E23_mod<-gamm(logTP~te(Year, dec.during, bs=c("cr", "cc")) +te(Year, dec.during, by=logq,  bs=c("cr", "cc")),data=E23, method="REML")
```

Extract fitted values and c-q slope for the entire year
```{r}
terms23<-predict.gam(E23_mod$gam, type="terms", newdata=E23, se.fit=TRUE)

```

Figure 8, left
Plot of the year-season varying c-q slope
Define a grid for plotting, years from start to end, season as decimal 0 to 1, logq equal to 1 to extract the slope parameter. Estimated coefficients on this grid and plot
```{r}
new<-expand.grid(dec.during=seq(0,1, length.out=50), logq=rep(1, 50), Year=seq(min(E23$Year), max(E23$Year), length.out=50))

terms_new<-predict.gam(E23_mod$gam, type="terms", newdata=new, se.fit=TRUE)
#terms_new1<-predict.gam(N34_mod$gam, type="response", exclude=c("te(year)", "te(decimal_during)"), newdata=new, se.fit=TRUE)

new$terms<-terms_new$fit[,1]+attr(terms23, "constant")
new$coeff<-terms_new$fit[,2]

new$cont_month=new$dec.during*12+1
new$Month=floor(new$cont_month)
new$coeff.upper<-new$coeff+1.96*terms_new$se.fit[,2]
new$coeff.lower<-new$coeff-1.96*terms_new$se.fit[,2]

breaks <- c(-0.4, -0.2, 0, 0.2, 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, 2.2, 2.4, 2.6)

new%>%
ggplot(aes(x=Year, y=cont_month, z=coeff)) +
  geom_contour_filled(breaks=breaks)+
  xlab("Year")+
  theme_bw()+
  scale_y_continuous(name="Month", breaks=c(1,3,5,7,9,11))+
  labs(fill = "c-q slope")+
  theme(text= element_text(size = 9), legend.position="bottom", axis.title.x = element_text(size = 16), axis.title.y = element_text(size = 16))
```


Plot individual month for illustration, Figure 8, right.

Sort out data in August using the continuous within year variable. Extract data in February and August

```{r}
new$cont_month=new$dec.during*12+1

new%>%filter(cont_month>8.4 & cont_month<8.6)%>%
  ggplot( aes(Year, coeff,coeff.lower,coeff.upper)) +
  geom_line(aes(y = coeff), color="red", lwd=2)+
  geom_line(aes(y = coeff.lower))+
  geom_line(aes(y = coeff.upper))+
  ylab("c-q slope")+
  geom_ribbon(aes(ymin=coeff.lower, ymax=coeff.upper),alpha=0.09, fill = "blue")+
  theme_bw()+
geom_line(data=new%>%filter(cont_month>2.4 & cont_month<2.6),aes(y = coeff), color="blue", lwd=2)+
    geom_line(data=new%>%filter(cont_month>2.4 & cont_month<2.6),aes(y = coeff.lower))+
  geom_line(data=new%>%filter(cont_month>2.4 & cont_month<2.6),aes(y = coeff.upper))+
  geom_ribbon(data=new%>%filter(cont_month>2.4 & cont_month<2.6),aes(ymin=coeff.lower, ymax=coeff.upper),alpha=0.09, fill = "blue")+
  theme(text= element_text(size = 16))
```



Seasonal
Model using a time-varying c-q slope without seasonality. Extract slopes and plot
```{r}
E23_mod_year<-gamm(logNO3~te(dec.date) +te(dec.date, by=logq),correlation=corCAR1(form=~dec.date),data=E23, method="REML")


terms1d<-predict.gam(E23_mod_year$gam, type="terms", newdata=E23, se.fit=TRUE)

E23$fit<-terms1d$fit[,1]+attr(terms1d, "constant")#+mean(terms1d$fit[,2], na.rm=TRUE)
E23$fit.upper<-E23$fit+1.96*terms1d$se.fit[,1]
E23$fit.lower<-E23$fit-1.96*terms1d$se.fit[,1]
E23$coeff<-terms1d$fit[,2]/E23$logq
E23$coeff.upper<-E23$coeff+1.96*terms1d$se.fit[,2]/abs(E23$logq)
E23$coeff.lower<-E23$coeff-1.96*terms1d$se.fit[,2]/abs(E23$logq)

ggplot(E23, aes(dec.date, coeff,coeff.lower,coeff.upper)) +
  geom_line(aes(y = coeff), color="red", lwd=2)+
  geom_line(aes(y = coeff.lower))+
  geom_line(aes(y = coeff.upper))+
  ylab("Regression coefficient")+
  xlab("Date")+
  geom_ribbon(aes(ymin=coeff.lower, ymax=coeff.upper),alpha=0.09, fill = "blue")+
  theme_bw()+
  ylim(0, 1.6)+
  theme(text= element_text(size = 16))

```
Figure 7, middle
Model for July, August, September
Fit model, extract slopes and plot.
```{r}

E23%>%filter(Month==7 | Month==8 | Month==9)->E23_summ

E23_mod_summ<-gamm(logNO3~te(dec.date) +te(dec.date, by=logq),correlation=corCAR1(form=~dec.date),data=E23_summ, method="REML")


terms1d<-predict.gam(E23_mod_summ$gam, type="terms", newdata=E23_summ, se.fit=TRUE)

E23_summ$fit<-terms1d$fit[,1]+attr(terms1d, "constant")+terms1d$fit[,2]/E23_summ$logq*mean(E23_summ$logq, na.rm=TRUE)
E23_summ$fit.upper<-E23_summ$fit+1.96*terms1d$se.fit[,1]
E23_summ$fit.lower<-E23_summ$fit-1.96*terms1d$se.fit[,1]
E23_summ$coeff<-terms1d$fit[,2]/E23_summ$logq
E23_summ$coeff.upper<-E23_summ$coeff+1.96*terms1d$se.fit[,2]/abs(E23_summ$logq)
E23_summ$coeff.lower<-E23_summ$coeff-1.96*terms1d$se.fit[,2]/abs(E23_summ$logq)


ggplot(E23_summ, aes(dec.date, coeff,coeff.lower,coeff.upper)) +
  geom_line(aes(y = coeff), color="red", lwd=2)+
  geom_line(aes(y = coeff.lower))+
  geom_line(aes(y = coeff.upper))+
  ylab("Regression coefficient")+
  xlab("Date")+
  ylim(0, 1.6)+
  geom_ribbon(aes(ymin=coeff.lower, ymax=coeff.upper),alpha=0.09, fill = "blue")+
  theme_bw()+
  theme(text= element_text(size = 16))
```
Figure 7, right
Model for January, February, March
Fit model, extract slopes and plot.
```{r}
E23%>%filter(Month==1 | Month==2 | Month==3)->E23_wint

E23_mod_wint<-gamm(logNO3~te(dec.date) +te(dec.date, by=logq),correlation=corCAR1(form=~dec.date),data=E23_wint, method="REML")


terms1d<-predict.gam(E23_mod_wint$gam, type="terms", newdata=E23_wint, se.fit=TRUE)

E23_wint$fit<-terms1d$fit[,1]+attr(terms1d, "constant") + terms1d$fit[,2]/E23_wint$logq*mean(E23_wint$logq, na.rm=TRUE)
E23_wint$fit.upper<-E23_wint$fit+1.96*terms1d$se.fit[,1]
E23_wint$fit.lower<-E23_wint$fit-1.96*terms1d$se.fit[,1]
E23_wint$coeff<-terms1d$fit[,2]/E23_wint$logq
E23_wint$coeff.upper<-E23_wint$coeff+1.96*terms1d$se.fit[,2]/abs(E23_wint$logq)
E23_wint$coeff.lower<-E23_wint$coeff-1.96*terms1d$se.fit[,2]/abs(E23_wint$logq)



ggplot(E23_wint, aes(dec.date, coeff,coeff.lower,coeff.upper)) +
  geom_line(aes(y = coeff), color="red", lwd=2)+
  geom_line(aes(y = coeff.lower))+
  geom_line(aes(y = coeff.upper))+
  ylab("Regression coefficient")+
  xlab("Date")+
  geom_ribbon(aes(ymin=coeff.lower, ymax=coeff.upper),alpha=0.09, fill = "blue")+
  theme_bw()+
  ylim(0, 1.6)+
  theme(text= element_text(size = 16))
```




NONLINEAR
Define seasons
```{r}
E23$seas<-1
E23$seas[E23$Month==3| E23$Month==4 | E23$Month ==5]<-2
E23$seas[E23$Month==6| E23$Month==7 | E23$Month ==8]<-3
E23$seas[E23$Month==9| E23$Month==10 | E23$Month ==11]<-4
E23$seas<-as.factor(E23$seas)
```

Run a model including different c-q slopes for separate seasons
```{r}
modE23_seas<-gamm(logNO3~s(dec.date)+seas+s(logq, by=seas),correlation=corCAR1(form = ~dec.date),method="REML", data=E23)
summary(modE23_seas$gam)
```

Basic model to extract standard slope
```{r}
modE23<-gamm(logNO3~s(dec.date)+logq,correlation=corCAR1(form = ~dec.date),method="REML", data=E23)
summary(modE23$gam)
```


Extract fits and confidence bands for the seasonal c-q slopes models, March to May
```{r}
terms1<-predict(modE23_seas$gam, type="terms", newdata=E23, se.fit=TRUE)

E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg<-terms1$se.fit[,4]
E23$line<-terms1$fit[,4]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper<-E23$line+2*terms1$se.fit[,4]
E23$Line_lower<-E23$line-2*terms1$se.fit[,4]
```

Figure 4, upper row, left
```{r}
E23%>%
  filter(seas==2)%>%
  ggplot(aes(x=logq, y=logNO3, Line_lower,Line_upper))+
  geom_point()+
  xlab("Discharge (log-transformed)")+
  ylab("Total nitrogen (log-transformed)")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
  theme_bw()+
 theme(text= element_text(size = 16), plot.title = element_text(size=16))+
  labs(title="March to May")->E23_2plot
```


Extract fits and confidence bands for the seasonal c-q slopes models, June to August
```{r}
E23$fit_seas<-terms1$fit[,1]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg<-terms1$se.fit[,5]
E23$line<-terms1$fit[,5]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper<-E23$line+2*terms1$se.fit[,5]
E23$Line_lower<-E23$line-2*terms1$se.fit[,5]
```

Figure 4, upper row, middle
```{r}
E23%>%
  filter(seas==3)%>%
  ggplot(aes(x=logq, y=logNO3, Line_lower,Line_upper))+
  geom_point()+
  xlab("Discharge (log-transformed)")+
  ylab("Total nitrogen (log-transformed)")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
  theme_bw()+
   theme(text= element_text(size = 16), plot.title = element_text(size=16))+
  labs(title="June to August")->E23_3plot
```

Extract fits and confidence bands for the seasonal c-q slopes models, September to November
```{r}
E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg<-terms1$se.fit[,6]
E23$line<-terms1$fit[,6]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper<-E23$line+2*terms1$se.fit[,6]
E23$Line_lower<-E23$line-2*terms1$se.fit[,6]
```

Figure 4, upper row, right
```{r}
E23%>%
  filter(seas==4)%>%
  ggplot(aes(x=logq, y=logNO3, Line_lower,Line_upper))+
  geom_point()+
  xlab("Discharge (log-transformed)")+
  ylab("Total nitrogen (log-transformed)")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
  theme_bw()+
   theme(text= element_text(size = 16), plot.title = element_text(size=16))+
  labs(title="September to November")->E23_4plot
```

Extract fits and confidence bands for the seasonal c-q slopes models, December to February
```{r}
E23$fit_seas<-terms1$fit[,2]+attr(terms1, "constant")+ mean(E23$logq, na.rm=TRUE)*summary(modE23$gam)$p.coeff[2]
E23$sereg<-terms1$se.fit[,3]
E23$line<-terms1$fit[,3]+mean(terms1$fit[,2], na.rm=TRUE)+attr(terms1, "constant")+ terms1$fit[,1]
E23$Line_upper<-E23$line+2*terms1$se.fit[,3]
E23$Line_lower<-E23$line-2*terms1$se.fit[,3]
```

Not shown in article, Figure December to February
```{r}
E23%>%
  filter(seas==1)%>%
  ggplot(aes(x=logq, y=logNO3, Line_lower,Line_upper))+
  geom_point()+
  xlab("Discharge (log-transformed)")+
  ylab("Total nitrogen (log-transformed)")+
  geom_ribbon(aes(ymin=Line_lower, ymax=Line_upper), fill="lightgreen", alpha=0.5)+
    geom_line(aes(x=logq, y=line), col="darkgreen",lwd=1)+
  theme_bw()+
   theme(text= element_text(size = 16), plot.title = element_text(size=16))+
  labs(title="December to February")->E23_1plot

```

```{r}

library(ggpubr)
ggarrange(E23_1plot, E23_2plot, E23_3plot, E23_4plot, ncol=2, nrow=2)
```

Extract c-q slopes from the seasonal model using derivatives 
```{r}
termsseas<-predict.gam(modE23_seas$gam, type="terms", newdata=E23, se.fit=TRUE)

ff_seas<-derivatives(modE23_seas)
```

Figure 4, lower row, left
```{r}
ff_seas%>%filter(var=="logq", smooth=="s(logq):seas2")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+
  ylab("c-q slope")+
  xlab("Discharge (log-transformed)")+
  ylim(-0.5,1.5)+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16))+
  labs(title="March to May")->E23_2_cqplot
```


Figure 4, lower row, middle
```{r}
ff_seas%>%filter(var=="logq", smooth=="s(logq):seas3")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+
  ylab("c-q slope")+
  xlab("Discharge (log-transformed)")+
  ylim(-0.5,1.5)+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16))+
  labs(title="June to August")->E23_3_cqplot
```

Figure 4, lower row, right
```{r}
ff_seas%>%filter(var=="logq", smooth=="s(logq):seas4")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+
  ylab("c-q slope")+
  xlab("Discharge (log-transformed)")+
  ylim(-0.5,1.5)+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  theme(text= element_text(size = 16), plot.title = element_text(size=16))+
  labs(title="September to November")->E23_4_cqplot
```

Figure December to February (not shown in article)
```{r}
ff_seas%>%filter(var=="logq", smooth=="s(logq):seas1")%>%
  ggplot(aes(data, derivative, lower, upper))+
  geom_line(aes(y=derivative), col="red", lwd=2)+
  geom_line(aes(y=lower))+
  geom_line(aes(y=upper))+
  ylab("c-q slope")+
  xlab("Discharge (log-transformed)")+
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.09, fill="blue")+
  theme_bw()+
  ylim(-0.5,1.5)+
    theme(text= element_text(size = 16), plot.title = element_text(size=16))+
  labs(title="December to February")->E23_1_cqplot


```

```{r}

library(ggpubr)
ggarrange(E23_1_cqplot, E23_2_cqplot, E23_3_cqplot, E23_4_cqplot, ncol=2, nrow=2)
```