---
title: "Simulations, Section 3.2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install and load necessary packages.
```{r}
library(tidyverse)
library(broom)
library(mgcv)
```

########################
Simulations, section 3.1
########################

##################################
Figure 1 (left): An example series
##################################

```{r}
set.seed(34)
r<-rnorm(100, 0, sqrt(1))
t<-seq(1:100)
q<-rnorm(100, 0, sqrt(1))
c=0+0.3*q+r
c1<-c
c1[1:100]<-c[1:100]+seq(1:100)/10
datatest<-data.frame(q=q, c=c, t=t, c1=c1)

datatest%>%
  ggplot(aes(x=t, y=c1))+
  geom_point()+
  geom_line(aes(x=t, y=q), col="blue")+
  ylab("")+
  xlab("Time")+
  theme_bw()+
  theme(text= element_text(size = 20))
```

Function to create generated data with the desired distributions and values for b
```{r}
Simdata<-function(n=n, d=100, g=1, beta=0.3, div=10){
	r<-rnorm(d, 0, sqrt(1))
t<-seq(1:d)
q<-rnorm(d, 0, sqrt(1))
c<-0+beta*q+r
c1<-c
c1[g:d]<-c[g:d]+seq(1:((d-g)+1))/div
sim<-rep(n, d)
out<-data.frame(q,c, c1, t,sim)

}
```

Simulate data
```{r}
s1 <- data.frame(q=numeric(),c=numeric(), c1=numeric(), t=numeric(), sim=numeric()) 
for (n in 1:1000){
  s<-Simdata(n)
  s1<-full_join(s1,s)
}
```

Run constant c-q slope models (LM_constant) for data without (c) and with (c1) trends in concentration
```{r}
s1%>%
  group_by(as.factor(sim))%>%
    nest() %>% 
  mutate(model = map(data, ~lm(c ~ q, data = .x) %>% 
                       tidy)) %>% 
  unnest(model) %>%
  filter(term == 'q')->a1

s1%>%
group_by(as.factor(sim))%>%
    nest() %>% 
  mutate(model = map(data, ~lm(c1 ~ q, data = .x) %>% 
                       tidy)) %>% 
   unnest(model) %>%
  filter(term == 'q')->a2
```

Model including a trend estimate when constant c-q slopes are estimated (GAM_constant), again on data without (c) and with (c1) trend in concentration.
```{r}
run_mod<-function(q=q, c=c, t=t, data=data){
mm <- gamm(c ~  s(t)+q , data=data,method="REML")  
	ss<-summary(mm$gam)
	return(ss$p.coeff[2])
}	
	
s1%>%
  group_by(as.factor(sim))%>%
  nest()%>%
  mutate(model =map(data, ~run_mod(c=c1, q=q, t=t, data=.x)))%>%
  unnest(model)  ->a3

s1%>%
  group_by(as.factor(sim))%>%
  nest()%>%
  mutate(model =map(data, ~run_mod(c=c, q=q, t=t, data=.x)))%>%
  unnest(model)  ->a4
```

#############################################################################################
Figure 1 (right): Boxplots of modelled c-q slopes for the four combination of models and data
#############################################################################################
```{r}
a1%>%left_join(a2, by="as.factor(sim)")%>%left_join(a3, by="as.factor(sim)")%>%left_join(a4,by="as.factor(sim)")->a_all

a_all%>%
  pivot_longer(cols=c("estimate.x", "estimate.y", "model.x", "model.y"))%>%
  mutate(groups=case_when(name=="estimate.x"~"no trend present (Model 1)",
                          name=="estimate.y"~"trend present (Model 1)",
                          name=="model.x"~"trend present (Model 2)",
                          name=="model.y"~"no trend present (Model 2)"))->a_plot
a_plot$groups<-factor(a_plot$groups, levels=c("no trend present (Model 1)", "no trend present (Model 2)", "trend present (Model 1)", "trend present (Model 2)"))

a_plot%>%mutate(trend=case_when(groups=="no trend present (Model 1)"~"No trend present",
                                groups=="no trend present (Model 2)"~"No trend present",
                                groups=="trend present (Model 1)"~"Trend present", 
                                groups=="trend present (Model 2)"~"Trend present"),
                model=case_when(groups=="no trend present (Model 1)"~"No trend\nmodelled",
                                groups=="no trend present (Model 2)"~"Trend\nmodelled",
                                groups=="trend present (Model 1)"~"No trend\nmodelled", 
                                groups=="trend present (Model 2)"~"Trend\nmodelled"))%>%
  ggplot(aes(y=value, x=model))+
  geom_boxplot()+
  xlab("")+
  ylab("Slope estimate b")+
  theme_bw()+
     theme(text= element_text(size = 20))+
    facet_wrap(~trend)

```


